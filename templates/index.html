<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias en Tiempo Real</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>ðŸ“° Noticias en Tiempo Real</h1>
        
        <!-- Barra de bÃºsqueda -->
        <input type="text" id="searchInput" placeholder="ðŸ”Ž Buscar noticias..." onkeyup="filtrarNoticias()">
        
        <!-- BotÃ³n para recargar -->
        <button id="reloadButton">ðŸ”„ Recargar Noticias</button>

        <!-- Barra de carga -->
        <div id="progressContainer">
            <p id="progressText">Procesando sitios: 0 / 0</p>
            <progress id="progressBar" value="0" max="100"></progress>
        </div>

        <!-- Tabla de noticias -->
        <table id="tablaNoticias">
            <thead>
                <tr>
                    <th>TÃ­tulo</th>
                    <th>Enlace</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- PaginaciÃ³n -->
        <div id="pagination">
            <button id="prevPage">â¬… </button>
            <span id="pageInfo">1</span>
            <button id="nextPage">âž¡</button>
        </div>
    </div>

    <script>
        var socket = io();
        let noticias = [];  // GuardarÃ¡ todas las noticias
        let currentPage = 1;
        let noticiasPorPagina = 10;

        socket.emit('buscar_noticias', {});

        socket.on('nueva_noticia', function(noticia) {
            noticias.push(noticia);
            mostrarNoticias();
        });

        socket.on('progreso', function (data) {
            let progressBar = document.getElementById("progressBar");
            progressBar.style.width = data.progreso + "%";
            
            // âœ… Mostrar "Procesando sitios: X / Y"
            document.getElementById("progressText").textContent = `Procesando sitios: ${data.procesados} / ${data.total}`;
        });

        document.getElementById("reloadButton").addEventListener("click", function() {
            document.getElementById("tablaNoticias").getElementsByTagName('tbody')[0].innerHTML = "";
            noticias = [];
            socket.emit('buscar_noticias', {});
        });

        function mostrarNoticias() {
            let tbody = document.getElementById("tablaNoticias").getElementsByTagName('tbody')[0];
            tbody.innerHTML = "";

            let inicio = (currentPage - 1) * noticiasPorPagina;
            let fin = inicio + noticiasPorPagina;
            let noticiasPagina = noticias.slice(inicio, fin);

            noticiasPagina.forEach(noticia => {
                let row = tbody.insertRow();
                row.insertCell(0).textContent = noticia.titulo;
                let link = document.createElement("a");
                link.href = noticia.enlace;
                link.target = "_blank";
                link.textContent = "ðŸ”— Ver noticia";
                row.insertCell(1).appendChild(link);
            });

            document.getElementById("pageInfo").textContent = `PÃ¡gina ${currentPage}`;
        }

        document.getElementById("prevPage").addEventListener("click", function() {
            if (currentPage > 1) {
                currentPage--;
                mostrarNoticias();
            }
        });

        document.getElementById("nextPage").addEventListener("click", function() {
            if (currentPage * noticiasPorPagina < noticias.length) {
                currentPage++;
                mostrarNoticias();
            }
        });

        function filtrarNoticias() {
            let filtro = document.getElementById("searchInput").value.toLowerCase();
            let tbody = document.getElementById("tablaNoticias").getElementsByTagName('tbody')[0];
            tbody.innerHTML = "";

            let noticiasFiltradas = noticias.filter(noticia => noticia.titulo.toLowerCase().includes(filtro));

            noticiasFiltradas.forEach(noticia => {
                let row = tbody.insertRow();
                row.insertCell(0).textContent = noticia.titulo;
                let link = document.createElement("a");
                link.href = noticia.enlace;
                link.target = "_blank";
                link.textContent = "ðŸ”— Ver noticia";
                row.insertCell(1).appendChild(link);
            });
        }
    </script>
</body>
</html>
