<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias en Tiempo Real</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>ðŸ“° Noticias en Tiempo Real</h1>
    <div class="top-bar">
        <input type="text" class="search-bar" id="searchInput" placeholder="Buscar noticias..." oninput="filtrarNoticias()">
        <button class="recargar" onclick="cargarNoticias()">ðŸ”„ Recargar Noticias</button>
    </div>
    
    <!-- Contador de progreso -->
    <div id="progreso-texto" class="status-text">Procesando: 0 / 70 sitios...</div>
    
    <!-- Barra de progreso -->
    <div class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
    </div>

    <div class="contenedor">
        <div id="noticias"></div>
        <div class="paginacion">
            <button id="prevPage" onclick="cambiarPagina(-1)" disabled>Anterior</button>
            <span id="pageInfo"></span>
            <button id="nextPage" onclick="cambiarPagina(1)">Siguiente</button>
        </div>
    </div>

    <script>
        let noticias = [];
        let noticiasFiltradas = [];
        let paginaActual = 1;
        const noticiasPorPagina = 7;
        let sitiosProcesados = 0;
        const totalSitios = 70;

        async function cargarNoticias() {
            const response = await fetch('/noticias');
            noticias = await response.json();
            noticiasFiltradas = noticias;
            paginaActual = 1;
            mostrarNoticias();
        }

        function mostrarNoticias() {
    const inicio = (paginaActual - 1) * noticiasPorPagina;
    const fin = inicio + noticiasPorPagina;
    const noticiasPagina = noticiasFiltradas.slice(inicio, fin);

    const contenedor = document.getElementById('noticias');
    contenedor.innerHTML = '';

    noticiasPagina.forEach(noticia => {
        const div = document.createElement('div');
        div.classList.add('noticia');
        div.innerHTML = `<span>${noticia.titulo}</span>  
                         <a href="${noticia.enlace}" target="_blank">ðŸ”— Enlace</a>`;
        contenedor.appendChild(div);
    });

    document.getElementById('pageInfo').textContent = `${paginaActual} de ${Math.ceil(noticiasFiltradas.length / noticiasPorPagina)}`;

    document.getElementById('prevPage').disabled = paginaActual === 1;
    document.getElementById('nextPage').disabled = fin >= noticiasFiltradas.length;
}


        function cambiarPagina(direccion) {
            paginaActual += direccion;
            mostrarNoticias();
        }

        function filtrarNoticias() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            noticiasFiltradas = noticias.filter(noticia => noticia.titulo.toLowerCase().includes(query));
            paginaActual = 1;
            mostrarNoticias();
        }

        async function actualizarProgreso() {
            const response = await fetch('/progreso');  // Suponiendo que el backend devuelve { procesados: X }
            const data = await response.json();
            sitiosProcesados = data.procesados;

            const porcentaje = (sitiosProcesados / totalSitios) * 100;
            document.getElementById('progreso-texto').textContent = `Procesando: ${sitiosProcesados} / ${totalSitios} sitios...`;
            document.getElementById('progress-bar').style.width = `${porcentaje}%`;

            if (sitiosProcesados < totalSitios) {
                setTimeout(actualizarProgreso, 2000); // Reintentar cada 2 segundos
            }
        }

        setInterval(cargarNoticias, 5000); // Actualiza noticias cada 5 segundos
        cargarNoticias();
        actualizarProgreso(); // Inicia la actualizaciÃ³n del progreso
    </script>
</body>
</html>
